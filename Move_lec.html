<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
:root {
--primary-color: #6C5CE7;
--secondary-color: #A29BFE;
--dark-color: #2D3436;
--light-color: #F5F6FA;
--accent-color: #00CE9F;
--danger-color: #E74C3C;
--warning-color: #F39C12;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Tajawal', sans-serif;
}

body {
background-color: var(--light-color);
color: var(--dark-color);
padding: 20px;
}

#page-content {
display: none;
}

.header {
text-align: center;
margin-bottom: 20px;
color: var(--primary-color);
font-size: 28px;
}

.filter-panel {
background-color: white;
padding: 15px;
border-radius: 10px;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
margin-bottom: 20px;
max-width: 1400px;
margin-left: auto;
margin-right: auto;
}

.form-select {
padding: 10px;
border: 1px solid #ddd;
border-radius: 8px;
font-size: 16px;
width: 300px;
max-width: 100%;
}

.main-content {
display: flex;
gap: 20px;
min-height: 70vh;
max-width: 1400px;
margin: 0 auto;
}

.lecture-list-panel {
flex: 1;
background-color: #f0f0f5;
padding: 15px;
border-radius: 10px;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
overflow-y: auto;
min-width: 300px;
max-height: 85vh;
}

.panel-title {
font-size: 18px;
font-weight: 700;
color: var(--dark-color);
margin-bottom: 15px;
border-bottom: 2px solid var(--secondary-color);
padding-bottom: 5px;
}

.months-container {
flex: 3;
display: grid;
grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
gap: 20px;
}

.month-column {
background-color: white;
padding: 15px;
border-radius: 10px;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
min-height: 200px;
border: 2px dashed transparent;
transition: background-color 0.2s, border-color 0.2s;
}

.drag-over {
background-color: #e6e0ff !important;
border-color: var(--primary-color) !important;
}

.lecture-item {
background-color: #fff;
padding: 10px;
border-radius: 6px;
margin-bottom: 8px;
cursor: grab;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
font-size: 14px;
font-weight: 500;
border-right: 4px solid var(--accent-color);
transition: opacity 0.2s;
display: flex;
justify-content: space-between;
align-items: center;
}

.is-dragging {
opacity: 0.4;
border-color: var(--primary-color);
border-style: solid;
}

.empty-state {
text-align: center;
color: #999;
padding: 20px 0;
font-size: 14px;
}

.loading-spinner {
border: 4px solid rgba(0, 0, 0, 0.1);
border-top: 4px solid var(--primary-color);
border-radius: 50%;
width: 20px;
height: 20px;
animation: spin 1s linear infinite;
display: inline-block;
margin-left: 5px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.alert {
padding: 12px 15px;
border-radius: 8px;
margin-bottom: 15px;
font-weight: 500;
text-align: center;
max-width: 1400px;
margin-left: auto;
margin-right: auto;
}

.alert-success {
background-color: #d1fae5;
color: #065f46;
border: 1px solid #6ee7b7;
}

.alert-danger {
background-color: #fee2e2;
color: #991b1b;
border: 1px solid #fca5a5;
}

.lecture-title {
flex-grow: 1;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
margin-left: 10px;
}

.move-btn {
background-color: var(--warning-color);
color: white;
border: none;
border-radius: 4px;
padding: 4px 8px;
font-size: 12px;
font-weight: 700;
cursor: pointer;
transition: background-color 0.2s;
flex-shrink: 0;
}

.move-btn:hover {
background-color: #e67e22;
}

.modal-overlay {
display: none;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: rgba(0, 0, 0, 0.5);
z-index: 1000;
justify-content: center;
align-items: center;
}

.modal-content {
background-color: white;
padding: 25px;
border-radius: 10px;
width: 90%;
max-width: 500px;
z-index: 1001;
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.modal-content h3 {
margin-top: 0;
margin-bottom: 20px;
color: var(--primary-color);
}

.modal-content .form-group {
margin-bottom: 15px;
}

.modal-content label {
display: block;
margin-bottom: 5px;
font-weight: 700;
}

.modal-content .form-select {
width: 100%;
}

.modal-actions {
margin-top: 25px;
display: flex;
justify-content: flex-end;
gap: 10px;
}

.modal-actions button {
padding: 10px 15px;
border: none;
border-radius: 8px;
font-size: 16px;
font-weight: 700;
cursor: pointer;
}

.modal-btn-confirm {
background-color: var(--primary-color);
color: white;
}

.modal-btn-cancel {
background-color: #eee;
color: var(--dark-color);
}

#move-modal-error {
color: var(--danger-color);
font-size: 14px;
margin-top: 10px;
display: none;
}

.back-btn-top {
    display: inline-block;
    background: #6C5CE7;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    text-decoration: none;
    font-weight: bold;
    margin-bottom: 20px;
}
</style>
</head>
<body>

<div style="text-align: left; padding: 10px 20px;">
    <a href="activation_stats.html" class="back-btn-top"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
</div>

<div id="page-content">
<h2 class="header">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø´Ù‡ÙˆØ±</h2>
<div id="alert-message"></div>

<div class="filter-panel">
<label for="year-selector" style="font-weight: 700; display: block; margin-bottom: 5px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³/Ø§Ù„Ø³Ù†Ø©:</label>
<select id="year-selector" class="form-select">
<option value="" disabled selected>--- Ø§Ø®ØªØ± ---</option>
</select>
</div>

<div class="main-content">

<div class="lecture-list-panel" id="uncategorized-container">
<div class="panel-title">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØµÙ†ÙØ©</div>
<div id="uncategorized-lectures" class="month-column" data-month-id="_uncategorized_"> <div class="empty-state">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ø±Ø³/Ø³Ù†Ø© Ø£ÙˆÙ„Ø§Ù‹...</div>
</div>
</div>

<div class="months-container" id="months-container">
<div class="empty-state">
<p>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡ÙˆØ± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³/Ø§Ù„Ø³Ù†Ø©.</p>
</div>
</div>

</div>
</div> <div class="modal-overlay" id="move-modal-overlay">
<div class="modal-content">
<h3>Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¥Ù„Ù‰ Ù…Ø¯Ø±Ø³ Ø¢Ø®Ø±</h3>
<div class="form-group">
<label for="move-teacher-select">1. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
<select id="move-teacher-select" class="form-select">
<option value="" disabled selected>--- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³ ---</option>
</select>
</div>
<div class="form-group">
<label for="move-month-select">2. Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± (Ù„Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯):</label>
<select id="move-month-select" class="form-select" disabled>
<option value="" disabled selected>--- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³ Ø£ÙˆÙ„Ø§Ù‹ ---</option>
</select>
</div>
<div id="move-modal-error">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³ ÙˆØ§Ù„Ø´Ù‡Ø±.</div>
<div class="modal-actions">
<button id="cancel-move-btn" class="modal-btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
<button id="confirm-move-btn" class="modal-btn-confirm">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„</button>
</div>
</div>
</div>


<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

<script>
// ==========================================================
// Firebase Config
// ==========================================================
const firebaseConfig = {
apiKey: 'AIzaSyCdqYrVFspJ4rZwidfaPtc9PYpNlQQm09k',
appId: '1:284879336757:web:1f42836c2382d11b73087c',
messagingSenderId: '284879336757',
projectId: 'amgg-81ac3',
authDomain: 'amgg-81ac3.firebaseapp.com',
databaseURL: 'https://amgg-81ac3-default-rtdb.firebaseio.com',
storageBucket: 'amgg-81ac3.firebasestorage.app',
};
if (!firebase.apps.length) {
firebase.initializeApp(firebaseConfig);
}
// ==========================================================
// Auth Guard
// ==========================================================
const auth = firebase.auth();
const database = firebase.database(); 

let teacherList = []; // [ØªØ¹Ø¯ÙŠÙ„] Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ù…

function showGlobalAlert(message, type = 'danger', autoClear = true) {
const alertDiv = document.getElementById('alert-message');
if (alertDiv) {
alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
if (autoClear) {
setTimeout(() => { if (alertDiv) alertDiv.innerHTML = ''; }, 5000);
}
} else {
alert(message);
}
}

auth.onAuthStateChanged(async user => {
if (user) {
    try {
        const adminSnap = await database.ref(`admins/${user.uid}`).once('value');
        const teacherSnap = await database.ref(`tea/${user.uid}`).once('value');

        if (adminSnap.exists()) {
            console.log('Admin access granted.');
            // Admin gets all 25
            teacherList = [];
            for(let i=1; i<=25; i++) teacherList.push(`Ù…Ø¯Ø±Ø³ ${i}`);
            
            document.getElementById('page-content').style.display = 'block';
            initializeAppLogic();
        } else if (teacherSnap.exists()) {
            const val = teacherSnap.val();
            teacherList = val.split('.').map(t => t.trim());
            console.log('Teacher access granted:', teacherList);
            
            document.getElementById('page-content').style.display = 'block';
            initializeAppLogic();
        } else {
            showGlobalAlert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.', 'danger', false);
            setTimeout(() => {
                auth.signOut();
                window.location.href = 'index.html'; 
            }, 3000);
        }
    } catch (e) {
        console.error("Auth Error", e);
        showGlobalAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.', 'danger', false);
    }
} else {
window.location.href = 'index.html';
}
});


// ==========================================================
// Main App Logic
// ==========================================================
function initializeAppLogic() {

const monthsRef = database.ref('months');
const lecturesRef = database.ref('lectures');

const yearSelector = document.getElementById('year-selector');
const monthsContainer = document.getElementById('months-container');
const uncategorizedContainer = document.getElementById('uncategorized-lectures');
const alertMessageDiv = document.getElementById('alert-message');

const moveModalOverlay = document.getElementById('move-modal-overlay');
const moveTeacherSelect = document.getElementById('move-teacher-select');
const moveMonthSelect = document.getElementById('move-month-select');
const confirmMoveBtn = document.getElementById('confirm-move-btn');
const cancelMoveBtn = document.getElementById('cancel-move-btn');
const moveModalError = document.getElementById('move-modal-error');

let currentYearKey = null;
let allMonthsData = {}; 
let allLecturesData = {}; 
let lectureToMoveData = null;

// [ØªØ¹Ø¯ÙŠÙ„] ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
yearSelector.innerHTML = '<option value="" disabled selected>--- Ø§Ø®ØªØ± ---</option>';
teacherList.forEach(t => {
    const option = document.createElement('option');
    option.value = t;
    option.textContent = t;
    yearSelector.appendChild(option);
});

// [Ø¬Ø¯ÙŠØ¯] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø³Ø§Ø¨Ù‚Ø§Ù‹
const savedTeacher = localStorage.getItem('selectedTeacher');
if(savedTeacher && teacherList.includes(savedTeacher)) {
    yearSelector.value = savedTeacher;
    fetchDataAndRender();
} else if (teacherList.length > 0) {
    // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø§Ø®ØªØ± Ø§Ù„Ø£ÙˆÙ„
    yearSelector.value = teacherList[0];
    fetchDataAndRender();
}


function showAlert(message, type = 'success') {
showGlobalAlert(message, type);
}


async function fetchDataAndRender() {
currentYearKey = yearSelector.value;
if (!currentYearKey) return;

// Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
localStorage.setItem('selectedTeacher', currentYearKey);

monthsContainer.innerHTML = `<div class="empty-state"><span class="loading-spinner"></span> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±...</div>`;
uncategorizedContainer.innerHTML = `<div class="empty-state"><span class="loading-spinner"></span></div>`;
alertMessageDiv.innerHTML = ''; 

try {
const monthSnapshot = await monthsRef.child(currentYearKey).once('value');
const rawMonths = monthSnapshot.val() || {};

const lectureSnapshot = await lecturesRef.child(currentYearKey).once('value');
allLecturesData = lectureSnapshot.val() || {};

allMonthsData = Object.entries(rawMonths).map(([id, data]) => ({ id, ...data }));
allMonthsData.sort((a, b) => (a.order || 999) - (b.order || 999));

renderUI();

} catch (error) {
console.error("Error fetching data:", error);
showAlert(`ğŸš« ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†.`, 'danger');
monthsContainer.innerHTML = `<div class="empty-state" style="color: var(--danger-color);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±.</div>`;
uncategorizedContainer.innerHTML = `<div class="empty-state" style="color: var(--danger-color);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª.</div>`;
}
}

function renderUI() {
if (allMonthsData.length === 0) {
monthsContainer.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡ÙˆØ± Ù…ÙØ¶Ø§ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¯Ø±Ø³/Ø§Ù„Ø³Ù†Ø©.</div>`;
} else {
monthsContainer.innerHTML = allMonthsData.map(month => `
<div class="month-column" data-month-id="${month.id}">
<div class="panel-title">${month.name || `Ø´Ù‡Ø± (${month.id})`}</div>
<div id="month-${month.id}-lectures">
<div class="empty-state">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¥Ù„Ù‰ Ù‡Ù†Ø§</div>
</div>
</div>
`).join('');
}

uncategorizedContainer.innerHTML = ''; 
document.querySelectorAll('.month-column > div[id$="-lectures"]').forEach(div => div.innerHTML = '');


let hasUncategorizedLectures = false;
let lecturesRenderedCount = 0;

Object.entries(allLecturesData).forEach(([key, value]) => {
const isMonthNode = allMonthsData.some(m => m.id === key);

if (isMonthNode && typeof value === 'object' && value !== null) {
const monthId = key;
const lecturesInMonth = value;
const container = document.getElementById(`month-${monthId}-lectures`);
if (container) {
container.innerHTML = ''; 
let lecturesAddedToMonth = false;
Object.entries(lecturesInMonth).forEach(([lectureId, lectureData]) => {
if (lectureData && lectureData.title) { 
container.innerHTML += createLectureItem(lectureId, lectureData, monthId);
lecturesAddedToMonth = true;
lecturesRenderedCount++;
}
});
if (!lecturesAddedToMonth) {
container.innerHTML = '<div class="empty-state">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¥Ù„Ù‰ Ù‡Ù†Ø§</div>';
}
}
} else if (value && value.title && !isMonthNode) {
const lectureId = key;
const lectureData = value;
uncategorizedContainer.innerHTML += createLectureItem(lectureId, lectureData, '_uncategorized_');
hasUncategorizedLectures = true;
lecturesRenderedCount++;
}
});


if (!hasUncategorizedLectures) {
uncategorizedContainer.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ù…ØµÙ†ÙØ©.</div>`;
}
if (allMonthsData.length === 0 && !hasUncategorizedLectures && lecturesRenderedCount === 0) {
monthsContainer.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡ÙˆØ± Ø£Ùˆ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©/Ø§Ù„Ù…Ø¯Ø±Ø³.</div>`;
}


document.querySelectorAll('.lecture-item').forEach(item => {
item.addEventListener('dragstart', handleDragStart);
item.addEventListener('dragend', handleDragEnd);
});
document.querySelectorAll('.month-column').forEach(column => {
column.addEventListener('dragover', handleDragOver);
column.addEventListener('dragleave', handleDragLeave);
column.addEventListener('drop', handleDrop);
});

document.querySelectorAll('.move-btn').forEach(btn => {
btn.addEventListener('click', handleMoveButtonClick);
});
}


function createLectureItem(id, data, parentMonthId) {
if (!data || typeof data.title === 'undefined') return '';
return `
<div class="lecture-item"
draggable="true"
data-lecture-id="${id}"
data-current-month-id="${parentMonthId}"
data-lecture-title="${data.title || 'Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}">

<div class="lecture-title">
${data.lectureNumber ? data.lectureNumber + '.' : ''} ${data.title || 'Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}
</div>
<button class="move-btn" title="Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù„Ù…Ø¯Ø±Ø³ Ø¢Ø®Ø±">Ù†Ù‚Ù„</button>
</div>
`;
}

// ==========================================================
// Drag and Drop Logic
// ==========================================================
let draggedLecture = null; 

function handleDragStart(e) {
if (e.target.classList.contains('lecture-item')) {
draggedLecture = e.target;
e.dataTransfer.setData('text/plain', e.target.dataset.lectureId);
e.dataTransfer.effectAllowed = 'move'; 
setTimeout(() => e.target.classList.add('is-dragging'), 0);
} else {
e.preventDefault(); 
}
}

function handleDragEnd(e) {
if (draggedLecture) {
draggedLecture.classList.remove('is-dragging');
}
draggedLecture = null; 
document.querySelectorAll('.month-column.drag-over').forEach(col => col.classList.remove('drag-over'));
}

function handleDragOver(e) {
e.preventDefault(); 
e.dataTransfer.dropEffect = 'move'; 

const dropTargetColumn = e.target.closest('.month-column');
if (dropTargetColumn && dropTargetColumn !== draggedLecture.parentElement) {
document.querySelectorAll('.month-column.drag-over').forEach(col => col.classList.remove('drag-over'));
dropTargetColumn.classList.add('drag-over');
}
}

function handleDragLeave(e) {
const dropTargetColumn = e.target.closest('.month-column');
if (dropTargetColumn) {
if (!dropTargetColumn.contains(e.relatedTarget)) {
dropTargetColumn.classList.remove('drag-over');
}
} else {
document.querySelectorAll('.month-column.drag-over').forEach(col => col.classList.remove('drag-over'));
}
}


async function handleDrop(e) {
e.preventDefault(); 
const dropTargetColumn = e.target.closest('.month-column');

if (!dropTargetColumn || !draggedLecture) {
if (draggedLecture) draggedLecture.classList.remove('is-dragging'); 
draggedLecture = null;
return;
}

dropTargetColumn.classList.remove('drag-over'); 

const newMonthId = dropTargetColumn.dataset.monthId;
const lectureId = draggedLecture.dataset.lectureId;
const oldMonthId = draggedLecture.dataset.currentMonthId;
const lectureTitle = draggedLecture.dataset.lectureTitle;

if (oldMonthId === newMonthId) {
draggedLecture.classList.remove('is-dragging'); 
draggedLecture = null;
return;
}

let targetLectureContainer = dropTargetColumn.querySelector('div[id$="-lectures"]');
if (newMonthId === '_uncategorized_') {
targetLectureContainer = dropTargetColumn;
}
const emptyState = targetLectureContainer.querySelector('.empty-state');
if (emptyState) {
targetLectureContainer.removeChild(emptyState);
}
targetLectureContainer.appendChild(draggedLecture);
draggedLecture.dataset.currentMonthId = newMonthId;
const oldContainer = document.querySelector(`[data-month-id="${oldMonthId}"]`).querySelector('div[id$="-lectures"]') || document.querySelector(`[data-month-id="${oldMonthId}"]`);
if (oldContainer && !oldContainer.querySelector('.lecture-item')) {
const emptyText = oldMonthId === '_uncategorized_' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ù…ØµÙ†ÙØ©.' : 'Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¥Ù„Ù‰ Ù‡Ù†Ø§';
oldContainer.innerHTML = `<div class="empty-state">${emptyText}</div>`;
}

const tempDragged = draggedLecture; 
draggedLecture = null;
if (tempDragged) tempDragged.classList.remove('is-dragging');


await updateLectureLocation(lectureId, oldMonthId, newMonthId, lectureTitle);
}


async function updateLectureLocation(lectureId, oldMonthId, newMonthId, lectureTitle) {
if (!currentYearKey || !lectureId) return;

const oldPath = (oldMonthId === '_uncategorized_')
? `lectures/${currentYearKey}/${lectureId}` 
: `lectures/${currentYearKey}/${oldMonthId}/${lectureId}`; 

const newPath = (newMonthId === '_uncategorized_')
? `lectures/${currentYearKey}/${lectureId}` 
: `lectures/${currentYearKey}/${newMonthId}/${lectureId}`; 

showAlert(`â³ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ "${lectureTitle}"...`, 'success'); 

try {
const snapshot = await database.ref(oldPath).once('value');
const lectureData = snapshot.val();

if (!lectureData) {
throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø±: ${oldPath}`);
}

lectureData.month = newMonthId; 

const updates = {};
updates[newPath] = lectureData; 
updates[oldPath] = null; Â  Â  Â  Â  

await database.ref().update(updates);

showAlert(`âœ… ØªÙ… Ù†Ù‚Ù„ "${lectureTitle}" Ø¨Ù†Ø¬Ø§Ø­!`, 'success');

if (oldMonthId === '_uncategorized_') {
delete allLecturesData[lectureId];
} else {
if (allLecturesData[oldMonthId]) {
delete allLecturesData[oldMonthId][lectureId];
}
}
if (newMonthId === '_uncategorVized_') {
allLecturesData[lectureId] = lectureData;
} else {
if (!allLecturesData[newMonthId]) {
allLecturesData[newMonthId] = {}; 
}
allLecturesData[newMonthId][lectureId] = lectureData;
}

} catch (error) {
console.error('Firebase Update Error:', error);
showAlert(`ğŸš« ÙØ´Ù„ Ø§Ù„Ù†Ù‚Ù„: ${error.message}. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.`, 'danger');
setTimeout(fetchDataAndRender, 1500); 
}
}

// ==========================================================
// Cross-Teacher Move
// ==========================================================

function handleMoveButtonClick(e) {
const lectureItem = e.target.closest('.lecture-item');
const lectureId = lectureItem.dataset.lectureId;
const monthId = lectureItem.dataset.currentMonthId;

lectureToMoveData = {
lectureId: lectureId,
oldMonthId: monthId,
oldTeacherKey: currentYearKey,
element: lectureItem 
};

openMoveModal();
}

function openMoveModal() {
moveTeacherSelect.innerHTML = '<option value="" disabled selected>--- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³ ---</option>';
teacherList.forEach(teacherKey => {
// [ØªØ¹Ø¯ÙŠÙ„] Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†Ù‚Ù„ Ù„Ø£ÙŠ Ù…Ø¯Ø±Ø³ Ø¢Ø®Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ÙŠÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
if (teacherKey !== currentYearKey) {
    const option = document.createElement('option');
    option.value = teacherKey;
    option.textContent = teacherKey;
    moveTeacherSelect.appendChild(option);
}
});

moveMonthSelect.innerHTML = '<option value="" disabled selected>--- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³ Ø£ÙˆÙ„Ø§Ù‹ ---</option>';
moveMonthSelect.disabled = true;
moveModalError.style.display = 'none';

moveModalOverlay.style.display = 'flex';
}

function closeMoveModal() {
lectureToMoveData = null; 
moveModalOverlay.style.display = 'none';
}

async function populateMoveModalMonths(e) {
const selectedTeacherKey = e.target.value;
if (!selectedTeacherKey) return;

moveMonthSelect.disabled = true;
moveMonthSelect.innerHTML = '<option value="" disabled selected>... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ...</option>';

try {
const snapshot = await monthsRef.child(selectedTeacherKey).once('value');
const months = snapshot.val() || {};

const monthsArray = Object.entries(months).map(([id, data]) => ({ id, ...data }));
monthsArray.sort((a, b) => (a.order || 999) - (b.order || 999)); 

moveMonthSelect.innerHTML = ''; 

const uncategorizedOption = document.createElement('option');
uncategorizedOption.value = '_uncategorized_';
uncategorizedOption.textContent = '(ØºÙŠØ± Ù…ØµÙ†Ù) - (Uncategorized)';
moveMonthSelect.appendChild(uncategorizedOption);

if (monthsArray.length === 0) {
} else {
monthsArray.forEach(month => {
const option = document.createElement('option');
option.value = month.id;
option.textContent = month.name || `Ø´Ù‡Ø± (${month.id})`;
moveMonthSelect.appendChild(option);
});
}
moveMonthSelect.disabled = false;

} catch (error) {
console.error("Error fetching months for modal:", error);
moveMonthSelect.innerHTML = '<option value="" disabled selected>! Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>';
}
}

async function executeCrossTeacherMove() {
const newTeacherKey = moveTeacherSelect.value;
const newMonthId = moveMonthSelect.value;

if (!newTeacherKey || !newMonthId) {
moveModalError.style.display = 'block';
return;
}
moveModalError.style.display = 'none';

confirmMoveBtn.disabled = true;
confirmMoveBtn.textContent = '...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ù‚Ù„...';

const { lectureId, oldMonthId, oldTeacherKey, element } = lectureToMoveData;

const oldPath = (oldMonthId === '_uncategorized_')
? `lectures/${oldTeacherKey}/${lectureId}`
: `lectures/${oldTeacherKey}/${oldMonthId}/${lectureId}`;

const newPath = (newMonthId === '_uncategorized_')
? `lectures/${newTeacherKey}/${lectureId}`
: `lectures/${newTeacherKey}/${newMonthId}/${lectureId}`;

try {
const snapshot = await database.ref(oldPath).once('value');
const lectureData = snapshot.val();
if (!lectureData) {
throw new Error("Lecture data not found at source.");
}

lectureData.month = newMonthId;
lectureData.year = newTeacherKey; 

const updates = {};
updates[oldPath] = null; 
updates[newPath] = lectureData; 

await database.ref().update(updates);

closeMoveModal();
showAlert(`âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ "${newTeacherKey}"!`, 'success');

const parentContainer = element.parentElement;
parentContainer.removeChild(element);
if (!parentContainer.querySelector('.lecture-item')) {
const emptyText = oldMonthId === '_uncategorized_' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ù…ØµÙ†ÙØ©.' : 'Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¥Ù„Ù‰ Ù‡Ù†Ø§';
parentContainer.innerHTML = `<div class="empty-state">${emptyText}</div>`;
}

if (oldMonthId === '_uncategorized_') {
delete allLecturesData[lectureId];
} else if (allLecturesData[oldMonthId]) {
delete allLecturesData[oldMonthId][lectureId];
}

} catch (error) {
console.error('Cross-teacher move error:', error);
showAlert(`ğŸš« ÙØ´Ù„ Ø§Ù„Ù†Ù‚Ù„: ${error.message}`, 'danger');
} finally {
confirmMoveBtn.disabled = false;
confirmMoveBtn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„';
}
}


yearSelector.addEventListener('change', fetchDataAndRender);

cancelMoveBtn.addEventListener('click', closeMoveModal);
moveModalOverlay.addEventListener('click', (e) => {
if (e.target === moveModalOverlay) closeMoveModal(); 
});
moveTeacherSelect.addEventListener('change', populateMoveModalMonths);
confirmMoveBtn.addEventListener('click', executeCrossTeacherMove);

} 

</script>
</body>
</html>