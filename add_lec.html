<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المحاضرات</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { --primary-color: #6C5CE7; --secondary-color: #A29BFE; --light-color: #F5F6FA; --dark-color: #2D3436; --success-color: #00CE9F; --danger-color: #E74C3C; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(to bottom, #f0f0f5, #ffffff);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
        }
        .container {
            width: 100%;
            max-width: 600px;
            padding: 24px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            direction: rtl;
            margin: 0 auto;
        }
        .appbar {
            background-color: #6C5CE7;
            color: white;
            padding: 16px;
            border-radius: 8px 8px 0 0;
            text-align: center;
            margin: -24px -24px 24px -24px;
        }
        .appbar h1 {
            margin: 0;
            font-size: 24px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2D3436;
        }
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .file-picker {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .file-picker label {
            background-color: #A29BFE;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }
        .file-picker label:hover {
            background-color: #8C80F7;
        }
        .file-picker input[type="file"] {
            display: none;
        }
        .file-picker span {
            font-size: 14px;
            color: #555;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .upload-btn {
            background-color: #00CE9F;
            margin-bottom: 10px;
        }
        .upload-btn:hover {
            background-color: #00B38B;
        }
        .delete-btn {
            background-color: #E74C3C;
        }
        .delete-btn:hover {
            background-color: #C0392B;
        }
        
        /* Loading Overlay Styles */
        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none; /* Hidden by default */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .progress-container {
            width: 80%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .progress-bar-track {
            width: 100%;
            height: 15px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00CE9F, #6C5CE7);
            border-radius: 10px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 206, 159, 0.5);
        }

        .progress-percentage {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
            font-family: monospace;
        }

        .progress-status {
            font-size: 16px;
            opacity: 0.9;
        }

        .hidden {
            display: none;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 10px 16px;
            background-color: #6C5CE7;
            color: white;
            border-radius: 8px 8px 0 0;
        }
        .modal-body {
            padding: 2px 16px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .modal-body ul {
            list-style: none;
            padding: 0;
        }
        .delete-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .delete-list-item:last-child {
            border-bottom: none;
        }
        .delete-list-item button {
            background-color: #E74C3C;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            margin-left: 10px;
        }
        .close:hover, .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .back-btn-top {
            align-self: flex-start;
            margin-bottom: 20px;
            margin-right: 10%;
            text-decoration: none;
            color: white;
            background: #6C5CE7;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<!-- شاشة التحميل (Overlay) -->
<div id="uploadOverlay" class="progress-overlay">
    <div class="progress-container">
        <div class="progress-percentage" id="overlayPercentage">0%</div>
        <div class="progress-bar-track">
            <div id="overlayProgressBar" class="progress-bar-fill"></div>
        </div>
        <div class="progress-status" id="overlayStatusText">جاري رفع المحاضرة، يرجى الانتظار وعدم إغلاق الصفحة...</div>
    </div>
</div>

<div style="width: 100%; max-width: 600px; text-align: left;">
    <a href="activation_stats.html" class="back-btn-top" style="display: inline-block; margin-bottom: 10px;"><i class="fas fa-arrow-right"></i> الرئيسية</a>
</div>

<div id="page-content" style="display: none; width: 100%;">
    <div class="container">
        <div class="appbar">
        <h1>إدارة المحاضرات</h1>
        </div>
        <h3>إضافة محاضرة جديدة</h3>
        <div class="input-group">
        <label for="lectureNumber">رقم المحاضرة</label>
        <input type="number" id="lectureNumber" placeholder="أدخل رقم المحاضرة">
        </div>
        <div class="input-group">
        <label for="title">عنوان المحاضرة</label>
        <input type="text" id="title" placeholder="أدخل عنوان المحاضرة">
        </div>
        
        <div class="input-group">
        <label for="year">اسم المدرس (السنة الدراسية)</label>
        <select id="year">
            </select>
        </div>
        
        <div class="input-group">
            <label for="month">الشهر الدراسي (اختياري)</label>
            <select id="month">
                <option value="_uncategorized_" selected>غير مصنف (رفع مباشر تحت السنة)</option>
                    </select>
        </div>

        <div class="input-group">
        <div class="file-picker">
        <label for="videoFile">اختيار فيديو</label>
        <input type="file" id="videoFile" accept="video/*">
        <span id="videoFileName">لم يتم اختيار فيديو</span>
        </div>
        </div>
        <div class="input-group">
        <div class="file-picker">
        <label for="logoFile">اختيار شعار (اختياري)</label>
        <input type="file" id="logoFile" accept="image/*">
        <span id="logoFileName">لم يتم اختيار شعار</span>
        </div>
        </div>
        <button id="uploadButton" class="button upload-btn">
        <span id="uploadText">رفع المحاضرة</span>
        </button>
        
        <hr style="margin: 20px 0;">
        <h3>حذف محاضرة موجودة</h3>
        <div class="input-group">
        <label for="deleteYear">اسم المدرس (السنة الدراسية)</label>
        <select id="deleteYear">
            </select>
        </div>
        <div class="input-group">
        <label for="deleteMonth">الشهر الدراسي</label>
        <select id="deleteMonth">
        <option value="_uncategorized_" selected>غير مصنف</option>
        </select>
        </div>
        <button id="showDeleteButton" class="button delete-btn">
        عرض المحاضرات للحذف
        </button>
        <div id="deleteModal" class="modal">
        <div class="modal-content">
        <div class="modal-header">
        <span class="close">&times;</span>
        <h2>اختيار محاضرة للحذف</h2>
        </div>
        <div class="modal-body">
        <ul id="lecturesList">
        </ul>
        </div>
        </div>
        </div>
    </div>
</div> <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script> <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-storage-compat.js"></script>
<script>
// Your Firebase configuration
const firebaseConfig = {
    apiKey: 'AIzaSyCdqYrVFspJ4rZwidfaPtc9PYpNlQQm09k',
    appId: '1:284879336757:web:1f42836c2382d11b73087c',
    messagingSenderId: '284879336757',
    projectId: 'amgg-81ac3',
    authDomain: 'amgg-81ac3.firebaseapp.com',
    databaseURL: 'https://amgg-81ac3-default-rtdb.firebaseio.com',
    storageBucket: 'amgg-81ac3.firebasestorage.app',
    measurementId: 'G-FMZW8S6WES',
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);

// ==========================================================
// ========== حارس الأمان ==========
// ==========================================================
const auth = firebase.auth();
const database = firebase.database();
const storage = firebase.storage();

let teacherList = []; // Array of allowed teachers for this user

auth.onAuthStateChanged(async user => {
    if (user) {
        try {
            const adminSnap = await database.ref(`admins/${user.uid}`).once('value');
            const teacherSnap = await database.ref(`tea/${user.uid}`).once('value');

            if (adminSnap.exists()) {
                console.log('Admin access granted.');
                // Admin has all 25 teachers
                teacherList = [];
                for(let i=1; i<=25; i++) teacherList.push(`مدرس ${i}`);
                
                document.getElementById('page-content').style.display = 'block';
                initializeAppLogic();
            } else if (teacherSnap.exists()) {
                const val = teacherSnap.val();
                // Split string by dot
                teacherList = val.split('.').map(t => t.trim());
                
                console.log('Teacher access granted:', teacherList);
                document.getElementById('page-content').style.display = 'block';
                initializeAppLogic();
            } else {
                alert('ليس لديك صلاحيات الوصول لهذه الصفحة.');
                auth.signOut();
                window.location.href = 'index.html';
            }
        } catch(e) {
            console.error(e);
        }
    } else {
        console.log('User not logged in. Redirecting...');
        window.location.href = 'index.html';
    }
});


function initializeAppLogic() {

    function getDbPath(year, month = '_uncategorized_', lectureId = null) {
        let path = `lectures/${year}`;
        if (month && month !== '_uncategorized_') {
            path += `/${month}`;
        }
        if (lectureId) {
            path += `/${lectureId}`;
        }
        return path;
    }
    
    async function loadMonthsForSelect(selectElement, year) {
        selectElement.innerHTML = '<option value="_uncategorized_" selected>غير مصنف (تحت السنة مباشرة)</option>';
        try {
            const snapshot = await database.ref(`months/${year}`).once('value');
            if (snapshot.exists()) {
                const months = snapshot.val();
                const monthsArray = Object.entries(months).map(([key, value]) => ({ id: key, ...value }));
                monthsArray.sort((a, b) => (a.order || 999) - (b.order || 999));
                monthsArray.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month.id;
                    option.textContent = month.name;
                    selectElement.appendChild(option);
                });
            }
        } catch (error) {
            console.error("Error loading months:", error);
        }
    }


    const titleInput = document.getElementById('title');
    const lectureNumberInput = document.getElementById('lectureNumber');
    const yearSelect = document.getElementById('year');
    const monthSelect = document.getElementById('month'); // For upload
    const videoFileInput = document.getElementById('videoFile');
    const logoFileInput = document.getElementById('logoFile');
    const videoFileNameSpan = document.getElementById('videoFileName');
    const logoFileNameSpan = document.getElementById('logoFileName');
    const uploadButton = document.getElementById('uploadButton');
    // UI Elements for Overlay
    const uploadOverlay = document.getElementById('uploadOverlay');
    const overlayProgressBar = document.getElementById('overlayProgressBar');
    const overlayPercentage = document.getElementById('overlayPercentage');
    const overlayStatusText = document.getElementById('overlayStatusText');

    const uploadText = document.getElementById('uploadText');
    const deleteYearSelect = document.getElementById('deleteYear');
    const deleteMonthSelect = document.getElementById('deleteMonth'); 
    const showDeleteButton = document.getElementById('showDeleteButton');
    const deleteModal = document.getElementById('deleteModal');
    const closeModal = document.querySelector('#deleteModal .close');
    const lecturesList = document.getElementById('lecturesList');

    // [هام] تعبئة القوائم (Year/Teacher) بناءً على القائمة المحملة من الصلاحيات
    yearSelect.innerHTML = '';
    deleteYearSelect.innerHTML = '';

    teacherList.forEach(teacherName => {
        // Upload Select
        const opt1 = document.createElement('option');
        opt1.value = teacherName;
        opt1.textContent = teacherName;
        yearSelect.appendChild(opt1);

        // Delete Select
        const opt2 = document.createElement('option');
        opt2.value = teacherName;
        opt2.textContent = teacherName;
        deleteYearSelect.appendChild(opt2);
    });

    // Check for local storage active teacher to set default selection
    const savedTeacher = localStorage.getItem('selectedTeacher');
    if(savedTeacher && teacherList.includes(savedTeacher)) {
        yearSelect.value = savedTeacher;
        deleteYearSelect.value = savedTeacher;
    }
    
    // Loading initial months
    loadMonthsForSelect(monthSelect, yearSelect.value);
    loadMonthsForSelect(deleteMonthSelect, deleteYearSelect.value);

    // Event listeners for selects
    yearSelect.addEventListener('change', () => loadMonthsForSelect(monthSelect, yearSelect.value));
    deleteYearSelect.addEventListener('change', () => loadMonthsForSelect(deleteMonthSelect, deleteYearSelect.value));
    
    videoFileInput.addEventListener('change', (event) => {
        const fileName = event.target.files[0] ? event.target.files[0].name : 'لم يتم اختيار فيديو';
        videoFileNameSpan.textContent = fileName;
    });
    logoFileInput.addEventListener('change', (event) => {
        const fileName = event.target.files[0] ? event.target.files[0].name : 'لم يتم اختيار شعار';
        logoFileNameSpan.textContent = fileName;
    });

    // --- Upload Logic ---
    uploadButton.addEventListener('click', async () => {
        const title = titleInput.value.trim();
        const lectureNumber = lectureNumberInput.value.trim();
        const selectedYear = yearSelect.value;
        const selectedMonth = monthSelect.value;
        const videoFile = videoFileInput.files[0];
        const logoFile = logoFileInput.files[0];

        if (!title || !lectureNumber || !videoFile) {
            alert('يرجى إدخال جميع البيانات المطلوبة');
            return;
        }

        uploadText.textContent = 'جاري الرفع...';
        uploadButton.disabled = true;
        // Show Overlay
        uploadOverlay.style.display = 'flex';
        overlayProgressBar.style.width = '0%';
        overlayPercentage.textContent = '0%';
        overlayStatusText.textContent = 'جاري تهيئة الرفع...';

        try {
            const lectureId = Date.now().toString();
            const baseName = `${lectureNumber}_${title.replace(/\s/g, '_')}`;

            const videoStorageRef = storage.ref(`lectures_data/${selectedYear}/${baseName}_${lectureId}.mp4`);
            
            const videoUploadTask = videoStorageRef.put(videoFile); 

            videoUploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    const progressRounded = Math.round(progress);
                    
                    // Update Overlay UI
                    overlayProgressBar.style.width = `${progress}%`;
                    overlayPercentage.textContent = `${progressRounded}%`;
                    overlayStatusText.textContent = `جاري رفع الفيديو... (${progressRounded}%)`;
                },
                (error) => {
                    console.error('Video upload failed', error);
                    alert(`حدث خطأ أثناء رفع الفيديو: ${error.message}`);
                    // Reset UI
                    uploadText.textContent = 'رفع المحاضرة';
                    uploadButton.disabled = false;
                    uploadOverlay.style.display = 'none';
                },
                async () => {
                    overlayStatusText.textContent = 'جاري معالجة البيانات وحفظها...';
                    try {
                        const videoPath = videoUploadTask.snapshot.ref.fullPath;
                        let logoPath = ''; 
                        
                        if (logoFile) {
                            overlayStatusText.textContent = 'جاري رفع الشعار...';
                            const logoStorageRef = storage.ref(`lectures_data/${selectedYear}/logos/${baseName}_${lectureId}.jpg`);
                            const logoUploadTask = logoStorageRef.put(logoFile);
                            await logoUploadTask;
                            logoPath = logoUploadTask.snapshot.ref.fullPath;
                        }

                        const dbPath = getDbPath(selectedYear, selectedMonth, lectureId);

                        overlayStatusText.textContent = 'جاري حفظ البيانات في قاعدة البيانات...';

                        await database.ref(dbPath).set({
                            id: lectureId,
                            title: title,
                            lectureNumber: lectureNumber,
                            year: selectedYear,
                            month: selectedMonth, 
                            videoPath: videoPath,
                            logoPath: logoPath,  
                            timestamp: Date.now()
                        });

                        alert('تم رفع المحاضرة بنجاح!');
                        
                        titleInput.value = '';
                        lectureNumberInput.value = '';
                        videoFileInput.value = '';
                        logoFileInput.value = '';
                        videoFileNameSpan.textContent = 'لم يتم اختيار فيديو';
                        logoFileNameSpan.textContent = 'لم يتم اختيار شعار';
                        uploadText.textContent = 'رفع المحاضرة';
                        uploadButton.disabled = false;
                        uploadOverlay.style.display = 'none'; // Hide Overlay
                        loadMonthsForSelect(deleteMonthSelect, deleteYearSelect.value);

                    } catch (error) {
                        console.error('Failed to save data or upload logo', error);
                        alert(`حدث خطأ بعد رفع الفيديو: ${error.message}`);
                        uploadText.textContent = 'رفع المحاضرة';
                        uploadButton.disabled = false;
                        uploadOverlay.style.display = 'none';
                    }
                }
            );
        } catch (error) {
            console.error('Upload failed', error);
            alert(`حدث خطأ أثناء رفع المحاضرة: ${error.message}`);
            uploadText.textContent = 'رفع المحاضرة';
            uploadButton.disabled = false;
            uploadOverlay.style.display = 'none';
        }
    });

    // --- Delete Logic ---
    showDeleteButton.addEventListener('click', async () => {
        const selectedYear = deleteYearSelect.value;
        const selectedMonth = deleteMonthSelect.value;
        lecturesList.innerHTML = '<li>جاري تحميل المحاضرات...</li>';

        try {
            const dbPath = getDbPath(selectedYear, selectedMonth);
            const snapshot = await database.ref(dbPath).once('value');
            lecturesList.innerHTML = ''; 

            if (snapshot.exists()) {
                const lecturesData = snapshot.val();
                let lectures = {};
                if (selectedMonth === '_uncategorized_') {
                    Object.keys(lecturesData).forEach(key => {
                        if (lecturesData[key] && lecturesData[key].title) {
                            lectures[key] = lecturesData[key];
                        }
                    });
                } else {
                    lectures = lecturesData;
                }
                const lectureKeys = Object.keys(lectures).filter(key => lectures[key] && lectures[key].title);

                if (lectureKeys.length > 0) {
                    lectureKeys.forEach(lectureId => {
                        const lecture = lectures[lectureId];
                        const li = document.createElement('li');
                        li.className = 'delete-list-item';
                        li.innerHTML = `
                            <span>${lecture.lectureNumber || ''} - ${lecture.title}</span>
                            <button onclick="deleteLecture('${selectedYear}', '${lectureId}', '${lecture.videoPath}', '${lecture.logoPath || ''}', '${selectedMonth}')">حذف</button>
                        `;
                        lecturesList.appendChild(li);
                    });
                    deleteModal.style.display = 'block';
                } else {
                    alert('لا توجد محاضرات في هذا الشهر/التصنيف.');
                }
            } else {
                alert('لا توجد محاضرات في هذا الشهر/التصنيف.');
            }
        } catch (error) {
            console.error("Error fetching lectures:", error);
            alert("حدث خطأ أثناء تحميل قائمة المحاضرات.");
        }
    });

    closeModal.onclick = function() {
        deleteModal.style.display = 'none';
    }
    window.onclick = function(event) {
        if (event.target == deleteModal) {
            deleteModal.style.display = 'none';
        }
    }

    window.deleteLecture = async function(year, lectureId, videoPath, logoPath, month) {
        if (!window.confirm('هل أنت متأكد من حذف هذه المحاضرة؟ هذا الإجراء لا يمكن التراجع عنه.')) return;

        try {
            const dbPath = getDbPath(year, month, lectureId);
            await database.ref(dbPath).remove();

            const videoStorageRef = storage.ref(videoPath);
            await videoStorageRef.delete();

            if (logoPath && logoPath.length > 0) {
                const logoStorageRef = storage.ref(logoPath);
                await logoStorageRef.delete();
            }

            alert('تم حذف المحاضرة بنجاح!');
            deleteModal.style.display = 'none';
            showDeleteButton.click(); 
        } catch (error) {
            console.error("Error deleting lecture:", error);
            alert("تم حذف بيانات المحاضرة من قاعدة البيانات، ولكن قد يكون هناك مشكلة في حذف الملفات.");
            deleteModal.style.display = 'none';
            showDeleteButton.click();
        }
    }
} 
</script>
</body>
</html>